# 端口转发测试完整指南

## 📋 测试环境

- **操作系统**: Windows 10/11
- **编程语言**: Go
- **测试工具**: Windows netsh, Go程序
- **测试场景**: 将本机8081端口转发到本机9999端口

## 🎯 测试目标

验证端口转发功能是否正常工作：
1. 源端口：8081 (外部访问端口)
2. 目标端口：9999 (Echo服务器监听端口)
3. 测试流程：客户端 → 8081端口 → 转发 → 9999端口 → Echo服务器

## 📁 测试文件说明

```
test/
├── echo_server.go        # Echo测试服务器（模拟目标服务）
├── test_client.go        # TCP测试客户端
├── test_port_forwarding.ps1  # 自动化测试脚本
└── 端口转发测试指南.md   # 本文档
```

## 🚀 快速开始

### 方法1：使用自动化测试脚本（推荐）

```powershell
# 1. 以管理员身份打开PowerShell

# 2. 进入测试目录
cd D:\devops\test-2025\docker-gpu-manage\test

# 3. 运行自动化测试脚本
.\test_port_forwarding.ps1
```

脚本会自动完成以下步骤：
1. ✅ 检查端口占用状态
2. ✅ 提示启动Echo服务器
3. ✅ 配置Windows端口转发
4. ✅ 验证转发规则
5. ✅ 测试端口连接
6. ✅ 测试数据传输

### 方法2：手动测试

#### 步骤1：启动Echo服务器（目标服务器）

打开**第一个终端窗口**：

```bash
# 进入测试目录
cd D:\devops\test-2025\docker-gpu-manage\test

# 启动Echo服务器（监听9999端口）
go run echo_server.go 9999
```

**预期输出：**
```
✅ Echo服务器已启动！
📡 监听地址: :9999
⏰ 启动时间: 2025-01-22 15:30:00
📝 服务器功能: 接收消息并原样返回
--------------------------------------------------
```

#### 步骤2：配置端口转发

打开**第二个终端窗口**（以管理员身份）：

```bash
# 添加端口转发规则
netsh interface portproxy add v4tov4 listenport=8081 listenaddress=0.0.0.0 connectport=9999 connectaddress=127.0.0.1
```

**预期输出：**
（无输出表示成功）

**验证转发规则：**
```bash
# 查看所有端口转发规则
netsh interface portproxy show all
```

**预期输出：**
```
侦听 ipv4:                 连接到 ipv4:

地址            端口        地址            端口
--------------- ----------  --------------- ----------
0.0.0.0         8081        127.0.0.1        9999
```

#### 步骤3：运行测试客户端

打开**第三个终端窗口**：

```bash
# 进入测试目录
cd D:\devops\test-2025\docker-gpu-manage\test

# 运行测试客户端
go run test_client.go -server=127.0.0.1:8081 -msg="Hello Test" -count=5
```

**命令行参数说明：**
- `-server`: 服务器地址（默认: 127.0.0.1:8081）
- `-msg`: 要发送的消息（默认: "Hello Port Forwarding!"）
- `-count`: 发送次数（默认: 1）
- `-interval`: 发送间隔毫秒数（默认: 1000）

**预期输出：**
```
========================================
     端口转发测试客户端
========================================
目标服务器: 127.0.0.1:8081
测试消息: Hello Test
发送次数: 5
发送间隔: 1000 ms
========================================

【第 1/5 次测试】
📡 已连接到服务器: 127.0.0.1:8081
⏰ 时间: 15:30:15.123
📤 发送: [1] Hello Test
📥 接收: Echo: [1] Hello Test [时间: 15:30:15]
✅ 测试通过

【第 2/5 次测试】
📡 已连接到服务器: 127.0.0.1:8081
⏰ 时间: 15:30:16.234
📤 发送: [2] Hello Test
📥 接收: Echo: [2] Hello Test [时间: 15:30:16]
✅ 测试通过

...

========================================
           测试结果统计
========================================
总测试次数: 5
✅ 成功: 5
❌ 失败: 0

🎉 所有测试通过！端口转发工作正常！
========================================
```

#### 步骤4：查看Echo服务器日志

在**第一个终端窗口**（Echo服务器）中，应该看到：

```
🔗 新连接来自: 127.0.0.1:54321

📨 收到消息: [1] Hello Test
📤 发送响应: Echo: [1] Hello Test [时间: 15:30:15]

📨 收到消息: [2] Hello Test
📤 发送响应: Echo: [2] Hello Test [时间: 15:30:16]

🔌 连接已关闭: 127.0.0.1:54321
```

## 🛠️ Windows端口转发管理命令

### 添加端口转发规则
```bash
netsh interface portproxy add v4tov4 listenport=8081 listenaddress=0.0.0.0 connectport=9999 connectaddress=127.0.0.1
```

### 查看所有转发规则
```bash
netsh interface portproxy show all
```

### 删除指定转发规则
```bash
netsh interface portproxy delete v4tov4 listenport=8081 listenaddress=0.0.0.0
```

### 删除所有转发规则
```bash
netsh interface portproxy reset
```

## 🧪 高级测试场景

### 场景1：测试并发连接

```bash
# 在多个终端窗口中同时运行
go run test_client.go -server=127.0.0.1:8081 -count=10 -interval=100
```

### 场景2：测试大数据包

```bash
# 发送长消息
go run test_client.go -server=127.0.0.1:8081 -msg="$(python -c 'print("A"*10000)')"
```

### 场景3：测试外部网络访问

```bash
# 从另一台机器访问（替换IP为本机局域网IP）
go run test_client.go -server=192.168.1.100:8081 -msg="Remote Test"
```

**注意：** 需要确保防火墙允许8081端口的入站连接。

### 场景4：测试持久连接

```bash
# 使用telnet进行交互式测试
telnet 127.0.0.1 8081

# 然后输入消息，按回车发送
```

## 🔍 故障排查

### 问题1：连接被拒绝

**错误信息：**
```
❌ 连接失败: dial tcp 127.0.0.1:8081: connectex: No connection could be made because the target machine actively refused it
```

**解决方案：**
1. 检查端口转发规则是否已配置：`netsh interface portproxy show all`
2. 确认Echo服务器正在运行
3. 检查端口是否被占用：`netstat -ano | findstr 8081`

### 问题2：连接超时

**错误信息：**
```
❌ 连接失败: dial tcp 127.0.0.1:8081: i/o timeout
```

**解决方案：**
1. 检查防火墙设置
2. 确认目标服务器正在运行：`netstat -ano | findstr 9999`
3. 尝试使用localhost而不是127.0.0.1

### 问题3：端口转发规则添加失败

**错误信息：**
```
⚠️ 添加规则时出现警告: The requested operation requires elevation.
```

**解决方案：**
- 必须以**管理员身份**运行PowerShell或命令提示符

### 问题4：权限不足

**错误信息：**
```
netsh interface portproxy add v4tov4 ... -> Access is denied
```

**解决方案：**
1. 右键点击PowerShell图标
2. 选择"以管理员身份运行"
3. 重新执行命令

## 📊 性能测试

### 测试吞吐量

```bash
# 发送1000条消息，间隔10ms
go run test_client.go -server=127.0.0.1:8081 -count=1000 -interval=10
```

### 使用专业工具测试

**使用iperf3测试带宽：**
```bash
# 服务端（9999端口）
iperf3 -s -p 9999

# 客户端（通过8081转发端口测试）
iperf3 -c 127.0.0.1 -p 8081 -t 10
```

## 🔐 安全建议

1. **仅转发必要的端口**：不要转发所有端口
2. **使用防火墙规则**：限制允许访问的源IP
3. **定期审计规则**：检查所有活动的端口转发规则
4. **使用加密**：对于敏感数据，使用SSH隧道或VPN

## 📝 测试检查清单

完成测试前，请确认：

- [ ] Echo服务器成功启动并监听9999端口
- [ ] 端口转发规则已配置
- [ ] `netsh interface portproxy show all` 显示正确规则
- [ ] 测试客户端成功连接到8081端口
- [ ] Echo服务器收到转发的消息
- [ ] 客户端收到Echo响应
- [ ] 多次测试都成功
- [ ] 并发测试正常

## 🎓 学习要点

### 端口转发原理

```
客户端 → [源IP:源端口] → 转发规则 → [目标IP:目标端口] → 目标服务器
        (例如 0.0.0.0:8081)    (127.0.0.1:9999)
```

### Windows netsh工作原理

- `netsh interface portproxy` 是Windows提供的端口转发功能
- 它在内核层拦截指定端口的连接
- 将连接透明地转发到另一个地址和端口
- 对客户端和服务器端都是透明的

### 应用场景

1. **内网穿透**：将公网服务器的端口转发到内网服务器
2. **端口映射**：将非标准端口映射到标准端口
3. **负载均衡**：结合多个转发规则实现简单负载分配
4. **开发测试**：模拟复杂的网络拓扑

## 📞 需要帮助？

如果测试过程中遇到问题：

1. **检查日志**：查看Echo服务器和测试客户端的输出
2. **验证配置**：确认端口转发规则正确
3. **网络诊断**：使用`telnet`或`nc`测试连接
4. **防火墙**：检查Windows防火墙设置

---

**测试愉快！** 🚀
