# 🔥 端口转发测试 - 立即开始

## ✅ 当前状态

- ✅ Echo服务器已启动（端口 9999）
- ✅ 测试客户端已准备就绪
- ⚠️ **需要创建端口转发规则**

---

## 📋 3步完成测试

### 步骤1：创建端口转发规则（必须）

**打开浏览器，按以下步骤操作：**

1. 访问：`http://localhost:8080`
2. 登录系统
3. 左侧菜单点击 **"端口转发"**
4. 点击 **"新建"** 按钮
5. 填写以下信息：

```
┌─────────────────────────────────────────┐
│ 源IP地址:    0.0.0.0                    │
│ 源端口:      8081                       │
│ 协议类型:    TCP                        │
│ 目标IP地址:  127.0.0.1                  │
│ 目标端口:    9999                       │
│ 状态:        ✅ 启用                     │
│ 规则描述:    测试转发                   │
└─────────────────────────────────────────┘
```

6. 点击 **"确定"**

**如果遇到"权限不足"：**

执行以下SQL（在MySQL中）：
```sql
USE your_database_name;

DELETE FROM casbin_rule WHERE v1 LIKE '/portForward%';
DELETE FROM sys_apis WHERE api_group = '端口转发';

INSERT INTO `sys_apis` (`path`, `description`, `api_group`, `method`) VALUES
('/portForward/createPortForward', '新建端口转发规则', '端口转发', 'POST'),
('/portForward/deletePortForward', '删除端口转发规则', '端口转发', 'DELETE'),
('/portForward/updatePortForward', '更新端口转发规则', '端口转发', 'PUT'),
('/portForward/updatePortForwardStatus', '更新端口转发规则状态', '端口转发', 'PUT'),
('/portForward/findPortForward', '根据ID获取端口转发规则', '端口转发', 'GET'),
('/portForward/getPortForwardList', '获取端口转发规则列表', '端口转发', 'GET'),
('/portForward/getServerIP', '获取服务器IP地址', '端口转发', 'GET');

INSERT INTO casbin_rule (ptype, v0, v1, v2)
SELECT 'p', sa.authority_id, CONCAT(sapi.path, sapi.method), sapi.method
FROM sys_authorities sa
CROSS JOIN sys_apis sapi
WHERE sapi.api_group = '端口转发';
```

然后：
- 退出登录
- 清除浏览器缓存（Ctrl + Shift + Delete）
- 重新登录
- 重新创建规则

### 步骤2：验证规则已启动

**查看后端服务日志，应该看到：**
```
[INFO] 端口转发已启动 rule_id=x source=0.0.0.0:8081 target=127.0.0.1:9999 protocol=tcp
```

或者在前端看到规则列表中该规则的"状态"开关是**开启**的绿色状态。

### 步骤3：运行测试

**打开一个新的 PowerShell 窗口，执行：**

```powershell
cd D:\devops\test-2025\docker-gpu-manage\test
go run test_client.go -server="127.0.0.1:8081" -count=5 -msg="Hello Test"
```

**或者使用批处理文件：**
```bash
cd D:\devops\test-2025\docker-gpu-manage\test
run_test.bat
```

---

## ✅ 成功标志

### 测试客户端输出：

```
🎉 所有测试通过！端口转发工作正常！
```

### Echo服务器输出：

```
🔗 新连接来自: 127.0.0.1:54321
📨 收到消息: [1] Hello Test
📤 发送响应: Echo: [1] Hello Test [时间: 16:30:15]
🔌 连接已关闭: 127.0.0.1:54321
```

### 后端日志输出：

```
[INFO] 端口转发已启动 rule_id=x source=0.0.0.0:8081 target=127.0.0.1:9999 protocol=tcp
[DEBUG] TCP连接已建立 rule_id=x client=127.0.0.1:54321 target=127.0.0.1:9999
```

---

## ❌ 故障排查

### 问题1：连接被拒绝

**错误**：`dial tcp 127.0.0.1:8081: connectex: No connection could be made`

**原因**：端口转发未启动

**解决**：
1. 检查规则状态是否为"启用"
2. 查看后端日志是否有错误
3. 重新编辑规则，关闭后再启用

### 问题2：收到HTTP响应

**错误**：`HTTP/1.1 400 Bad Request`

**原因**：连接到后端HTTP服务而不是端口转发器

**解决**：
- 确认端口转发规则已创建且状态为启用
- 后端服务会自动转发8081端口的连接

### 问题3：权限不足

**解决**：执行上面的SQL脚本修复权限

---

## 🎯 快速命令

**创建规则后，立即测试：**

```powershell
cd D:\devops\test-2025\docker-gpu-manage\test
go run test_client.go -server="127.0.0.1:8081" -count=5
```

**更简单的测试（1次）：**

```powershell
cd D:\devops\test-2025\docker-gpu-manage\test
go run test_client.go -server="127.0.0.1:8081" -count=1
```

---

## 📊 测试原理

```
测试客户端 → 127.0.0.1:8081 (端口转发器)
                            ↓
                      转发到 ↓
                            ↓
                   127.0.0.1:9999 (Echo服务器)
                            ↓
                      返回响应 ↓
                            ↓
                      测试客户端
```

**数据流向：**
1. 客户端连接到 `127.0.0.1:8081`
2. Go转发器接收连接
3. 转发器连接到 `127.0.0.1:9999` (Echo服务器)
4. Echo服务器返回消息
5. 转发器转发回客户端
6. 客户端验证响应格式

---

## 🎉 完成测试后

**清理资源（可选）：**
```powershell
# 停止Echo服务器（Ctrl+C）
# 或通过前端禁用端口转发规则
```

**保留规则：**
- 如果规则保持启用状态，后端重启后会自动启动转发
- 可以随时使用8081端口访问9999端口的服务

---

**现在请按照步骤1创建端口转发规则，然后告诉我"已完成"，我会帮您验证！** 🚀
