# 🎯 端口转发规则修改指南

## 📋 操作步骤

### 步骤1：修改规则端口

**在前端界面操作：**

1. 打开浏览器访问：`http://localhost:8080`
2. 登录系统
3. 进入**"端口转发"**菜单
4. 找到您创建的规则，点击**"修改"**按钮
5. 修改**"源端口"**为：
   - `8082`（推荐）或
   - `8888`（推荐）或
   - 其他未被占用的端口
6. 点击**"确定"**保存

### 步骤2：确认转发器已启动

**查看后端服务日志（启动后端的窗口）**，应该看到：

```
[INFO] 端口转发已启动 rule_id=x source=0.0.0.0:8082 target=127.0.0.1:9999 protocol=tcp
```

或

```
[INFO] 端口转发已启动 rule_id=x source=0.0.0.0:8888 target=127.0.0.1:9999 protocol=tcp
```

### 步骤3：运行测试

**修改规则后，在PowerShell中运行对应的测试脚本：**

**如果使用8082端口：**
```powershell
cd D:\devops\test-2025\docker-gpu-manage\test
.\test_8082.bat
```

**或手动运行：**
```powershell
cd D:\devops\test-2025\docker-gpu-manage\test
go run test_client.go -server="127.0.0.1:8082" -count=5 -msg="Hello Test"
```

**如果使用8888端口：**
```powershell
cd D:\devops\test-2025\docker-gpu-manage\test
.\test_8888.bat
```

**或手动运行：**
```powershell
cd D:\devops\test-2025\docker-gpu-manage\test
go run test_client.go -server="127.0.0.1:8888" -count=5 -msg="Hello Test"
```

---

## ✅ 预期成功输出

```
========================================
     端口转发测试客户端
========================================
目标服务器: 127.0.0.1:8082 (或8888)
测试消息: Hello Test
发送次数: 5
========================================

【第 1/5 次测试】
📡 已连接到服务器: 127.0.0.1:8082
⏰ 时间: 16:30:15.123
📤 发送: [1] Hello Test
📥 接收: Echo: [1] Hello Test [时间: 16:30:15]
✅ 测试通过

【第 2/5 次测试】
📡 已连接到服务器: 127.0.0.1:8082
⏰ 时间: 16:30:16.234
📤 发送: [2] Hello Test
📥 接收: Echo: [2] Hello Test [时间: 16:30:16]
✅ 测试通过

【第 3/5 次测试】
📡 已连接到服务器: 127.0.0.1:8082
⏰ 时间: 16:30:17.345
📤 发送: [3] Hello Test
📥 接收: Echo: [3] Hello Test [时间: 16:30:17]
✅ 测试通过

【第 4/5 次测试】
📡 已连接到服务器: 127.0.0.1:8082
⏰ 时间: 16:30:18.456
📤 发送: [4] Hello Test
📥 接收: Echo: [4] Hello Test [时间: 16:30:18]
✅ 测试通过

【第 5/5 次测试】
📡 已连接到服务器: 127.0.0.1:8082
⏰ 时间: 16:30:19.567
📤 发送: [5] Hello Test
📥 接收: Echo: [5] Hello Test [时间: 16:30:19]
✅ 测试通过

========================================
           测试结果统计
========================================
总测试次数: 5
✅ 成功: 5
❌ 失败: 0

🎉 所有测试通过！端口转发工作正常！
========================================
```

---

## 🔍 故障排查

### 问题1：连接被拒绝

**错误**：`dial tcp 127.0.0.1:8082: connectex: No connection could be made because the target machine actively refused it`

**原因**：端口转发器没有成功启动

**解决**：
1. 检查后端日志是否有错误
2. 确认规则状态为"启用"
3. 重新编辑规则，再次点击"确定"触发启动

### 问题2：端口被占用

**解决**：尝试其他端口（如 8888, 9000, 9001 等）

---

## 📊 数据流向

```
测试客户端 → 127.0.0.1:8082/8888 → Go转发器 → 127.0.0.1:9999 → Echo服务器
                                      ↓
                                转发数据 ↓
                                      ↓
测试客户端 ← 接收Echo响应 ←────────────┘
```

---

## 💡 提示

1. **Echo服务器已运行**（9999端口）✅
2. **只需修改源端口**到可用端口即可
3. **保存规则后转发器会自动启动**
4. **推荐使用8082或8888端口**

---

**修改规则后，立即运行测试即可！** 🚀
