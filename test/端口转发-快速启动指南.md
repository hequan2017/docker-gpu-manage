# 🚀 端口转发模块 - 快速启动指南

## ✅ 已完成的修改

我刚刚为您的项目添加了端口转发插件的注册：

**修改的文件：**
- `server/initialize/plugin_biz_v2.go` - 添加了 `portforward.Plugin` 的导入和注册

---

## 🎯 接下来的步骤

### 步骤1：重启后端服务 ⚠️ **重要！**

**您必须重启后端服务，菜单才会被创建！**

#### Windows系统：

```bash
# 1. 打开命令行，进入server目录
cd D:\devops\test-2025\docker-gpu-manage\server

# 2. 如果服务正在运行，先停止（Ctrl+C）

# 3. 重新编译和运行
go mod tidy
go run main.go
```

#### 或者使用可执行文件：

```bash
# 编译
go build -o server.exe

# 运行
./server.exe
```

---

### 步骤2：验证菜单是否创建

**方式1：使用SQL脚本验证（推荐）**

我已经为您创建了完整的验证脚本：`端口转发-快速验证和授权.sql`

执行以下查询：

```sql
-- 查看端口转发菜单
SELECT
    id,
    parent_id,
    title,
    path,
    name
FROM sys_base_menus
WHERE name LIKE 'portForward%'
ORDER BY parent_id, sort;
```

**期望结果：** 应该看到2条记录
- `端口转发`（父菜单，parent_id=0）
- `转发规则`（子菜单，parent_id=父菜单ID）

**方式2：查看服务器日志**

启动时应该看到类似的日志：
```
[INFO] 注册表成功!
[INFO] 菜单注册成功
```

---

### 步骤3：为角色授权 ⚠️ **必须！**

**菜单不会自动显示，必须为角色授权！**

#### 方式1：使用后台界面（推荐，最简单）

1. 登录系统（使用管理员账号）
2. 点击顶部菜单 **"超级管理员"**
3. 点击左侧 **"角色管理"**
4. 找到需要授权的角色（如"管理员"），点击 **"设置权限"**
5. 在权限树中找到 **"端口转发"** 节点
6. 勾选所有需要的权限（菜单和API）
7. 点击 **"确定"** 保存

#### 方式2：使用SQL脚本

1. 打开 `端口转发-快速验证和授权.sql`
2. 找到"第四步：为管理员角色授权"部分
3. 将角色ID（默认为888）替换为您的实际角色ID
4. 执行INSERT语句

---

### 步骤4：前端验证

1. **清除浏览器缓存**
   - 按 `Ctrl + Shift + Delete`
   - 或按 `F12` 打开开发者工具，右键刷新按钮，选择"清空缓存并硬性重新加载"

2. **退出登录**

3. **重新登录**

4. **查看左侧菜单**
   - 应该看到 **"端口转发"** 顶级菜单
   - 点击展开，看到 **"转发规则"** 子菜单
   - 点击进入管理页面

---

## 🔍 故障排查

### 问题1：菜单不显示

**可能原因和解决方法：**

| 原因 | 解决方法 |
|------|----------|
| 服务未重启 | 重启后端服务 |
| 角色未授权 | 在"角色管理"中为角色分配权限 |
| 浏览器缓存 | 清除浏览器缓存并重新登录 |
| 菜单未创建 | 执行验证SQL检查菜单是否存在 |

### 问题2：服务启动失败

**检查步骤：**

```bash
# 1. 检查Go版本（需要Go 1.23+）
go version

# 2. 清理并重新下载依赖
go mod tidy

# 3. 查看具体错误信息
go run main.go
```

### 问题3：数据库错误

**验证数据库连接：**

```sql
-- 测试数据库连接
SELECT 1;

-- 查看现有表
SHOW TABLES;
```

---

## 📋 快速检查清单

使用此清单确认所有步骤：

### 后端检查

- [ ] 已修改 `server/initialize/plugin_biz_v2.go`
- [ ] 已执行 `go mod tidy`
- [ ] 已重启后端服务
- [ ] 服务启动无错误
- [ ] 数据库表 `gva_port_forward` 已创建
- [ ] 数据库菜单记录已创建（执行验证SQL）
- [ ] 数据库API记录已创建（执行验证SQL）

### 权限检查

- [ ] 已在"角色管理"中为角色分配权限
- [ ] 权限树中能看到"端口转发"节点
- [ ] 已勾选菜单权限
- [ ] 已勾选API权限
- [ ] 已保存权限设置

### 前端检查

- [ ] 已清除浏览器缓存
- [ ] 已退出登录
- [ ] 已重新登录
- [ ] 左侧菜单能看到"端口转发"
- [ ] 点击能展开子菜单
- [ ] 点击"转发规则"能进入页面

---

## 🎯 预期结果

完成所有步骤后，您应该看到：

### 左侧菜单结构
```
┌─────────────────────┐
│ 🏠 首页             │
│ 📁 热门管理         │
│ 📁 系统管理         │
│ 📁 端口转发 ⬅       │ ← 新增的顶级菜单
│   └─ 📋 转发规则 ⬅  │ ← 子菜单
│ ...                 │
└─────────────────────┘
```

### 管理页面功能

- ✅ 新增端口转发规则
- ✅ 编辑端口转发规则
- ✅ 删除端口转发规则
- ✅ 批量删除
- ✅ 启用/禁用状态切换
- ✅ 搜索和过滤
- ✅ 分页查询

---

## 📞 需要帮助？

如果按照以上步骤操作后仍然看不到菜单：

### 1. 执行诊断SQL

```sql
-- 检查菜单是否存在
SELECT * FROM sys_base_menus WHERE name LIKE 'portForward%';

-- 检查API是否存在
SELECT * FROM sys_apis WHERE api_group = '端口转发';

-- 检查当前用户角色
SELECT * FROM sys_users WHERE nick_name = '当前用户名';

-- 检查角色权限
SELECT * FROM sys_authority_menus
WHERE sys_authority_authority_id = '您的角色ID';
```

### 2. 查看服务器日志

启动时查看是否有错误信息，特别注意：
- 数据库连接错误
- 插件注册错误
- 表创建错误

### 3. 手动创建菜单（最后手段）

如果自动创建失败，可以手动执行：

```sql
-- 创建父菜单
INSERT INTO sys_base_menus (created_at, updated_at, parent_id, path, name, hidden, component, sort, menu_level)
VALUES (NOW(), NOW(), 0, '/portForward', 'portForward', 0, 'view/routerHolder.vue', 10, 0);

-- 获取父菜单ID
SET @parent_id = LAST_INSERT_ID();

-- 创建子菜单
INSERT INTO sys_base_menus (created_at, updated_at, parent_id, path, name, hidden, component, sort, menu_level)
VALUES (NOW(), NOW(), @parent_id, 'portForwardRules', 'portForwardRules', 0, 'plugin/portforward/view/portForward.vue', 1, 1);
```

---

## ✅ 成功标志

当您看到以下内容时，说明配置成功：

1. ✅ 服务启动正常，无错误日志
2. ✅ 数据库中有2条菜单记录
3. ✅ 数据库中有7条API记录
4. ✅ 角色已分配权限
5. ✅ 前端能看到"端口转发"菜单
6. ✅ 能进入管理页面

**恭喜！端口转发模块已成功部署！** 🎉

---

## 📚 相关文档

- `端口转发-配置说明.md` - 详细配置说明
- `端口转发-角色授权示例.sql` - 完整授权SQL示例
- `端口转发-快速验证和授权.sql` - 诊断和验证脚本
- `端口转发-部署总结.md` - 完整部署文档

---

**祝您使用愉快！** 🚀
