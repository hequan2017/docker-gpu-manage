# 端口转发权限不足问题 - 快速解决方案

## 🚨 问题现象

点击"新建"按钮时提示：**权限不足**

## ✅ 解决方案

### 方法1：重新初始化API权限（推荐）

**步骤1：停止后端服务**

按 `Ctrl+C` 停止当前运行的后端服务

**步骤2：删除并重新初始化数据库**

```bash
cd D:\devops\test-2025\docker-gpu-manage\server
```

**步骤3：检查配置文件**

查看 `config.yaml` 中的数据库配置：
```yaml
mysql:
  path: '127.0.0.1:3306'
  config: 'charset=utf8mb4&parseTime=True&loc=Local'
  db-name: '库名'
  username: '用户名'
  password: '密码'
```

**步骤4：删除并重建数据库表（警告：会清空数据）**

```sql
-- 连接到MySQL
mysql -u root -p

-- 选择数据库
use gva;  -- 替换为你的数据库名

-- 查看端口转发API是否存在
SELECT * FROM sys_apis WHERE api_group = '端口转发';

-- 如果返回结果为空，说明API未初始化
-- 需要重新启动后端服务让初始化代码运行
```

**步骤5：重新启动后端服务**

```bash
go run main.go
```

后端启动时会自动：
1. 创建所有端口转发API（在 `sys_apis` 表）
2. 同步端口转发规则
3. 启动所有启用的转发

**步骤6：重新登录前端**

1. 退出当前登录
2. 清除浏览器缓存（Ctrl + Shift + Delete）
3. 重新登录
4. 尝试新建端口转发规则

---

### 方法2：手动添加API权限（如果方法1无效）

#### 步骤1：连接数据库

```bash
mysql -u root -p
use your_database_name;
```

#### 步骤2：检查API是否存在

```sql
SELECT id, path, method, description FROM sys_apis WHERE api_group = '端口转发';
```

#### 步骤3：如果API不存在，手动插入

```sql
INSERT INTO `sys_apis` (`path`, `description`, `api_group`, `method`, `created_at`, `updated_at`) VALUES
('/portForward/createPortForward', '新建端口转发规则', '端口转发', 'POST', NOW(), NOW()),
('/portForward/deletePortForward', '删除端口转发规则', '端口转发', 'DELETE', NOW(), NOW()),
('/portForward/deletePortForwardByIds', '批量删除端口转发规则', '端口转发', 'DELETE', NOW(), NOW()),
('/portForward/updatePortForward', '更新端口转发规则', '端口转发', 'PUT', NOW(), NOW()),
('/portForward/updatePortForwardStatus', '更新端口转发规则状态', '端口转发', 'PUT', NOW(), NOW()),
('/portForward/findPortForward', '根据ID获取端口转发规则', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getPortForwardList', '获取端口转发规则列表', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getServerIP', '获取服务器IP地址', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getForwarderStatus', '获取端口转发运行状态', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getAllForwarderStatus', '获取所有端口转发运行状态', '端口转发', 'GET', NOW(), NOW());
```

#### 步骤4：查询你的角色ID

```sql
-- 查看当前用户
SELECT uuid, nick_name, authority_id FROM sys_users WHERE nick_name LIKE '%admin%';

-- 查看角色ID
SELECT authority_id, authority_name FROM sys_authorities;
```

通常：
- 超级管理员角色ID: `888`
- 普通管理员角色ID: `999`

#### 步骤5：为角色添加API权限

```sql
-- 假设你的角色ID是888，如果不是请替换
SET @role_id = 888;

-- 为角色添加所有端口转发API权限
INSERT INTO `casbin_rule` (`ptype`, `v0`, `v1`, `v2`)
SELECT 'p', @role_id, CONCAT(path, method), method
FROM sys_apis
WHERE api_group = '端口转发';
```

#### 步骤6：验证权限

```sql
-- 查看角色的端口转发权限
SELECT * FROM casbin_rule
WHERE ptype = 'p'
  AND v0 = @role_id
  AND v1 LIKE '/portForward%'
ORDER BY v1;
```

#### 步骤7：重新登录

1. 退出前端登录
2. 清除浏览器缓存
3. 重新登录

---

### 方法3：使用超级管理员账号

如果你当前使用的不是超级管理员账号：

1. **使用默认超级管理员登录**
   - 用户名：`admin`
   - 密码：`123456`（首次安装）

2. **检查当前用户权限**
   ```sql
   -- 查看当前用户信息
   SELECT u.uuid, u.nick_name, u.authority_id, a.authority_name
   FROM sys_users u
   JOIN sys_authorities a ON u.authority_id = a.authority_id;
   ```

3. **如果密码忘记，重置管理员密码**

```sql
-- 生成新密码的哈希值（密码：123456）
UPDATE sys_users
SET password = '$2a$10$0K0fHd5/4v1QuYqHQZqXKeOJjNXUg0VjCYTZ5JFPuF8VD5KEXZHvK'
WHERE uuid = 'admin-uuid';  -- 替换为实际的admin UUID
```

---

## 🔍 故障排查

### 检查1：API是否创建

```sql
SELECT COUNT(*) as api_count
FROM sys_apis
WHERE api_group = '端口转发';
```

- 如果返回 `0`：API未创建，运行方法2的SQL
- 如果返回 `10`：API已创建，检查权限

### 检查2：权限是否分配

```sql
-- 查看所有角色
SELECT authority_id, authority_name FROM sys_authorities;

-- 查看某个角色的端口转发权限（替换888为你的角色ID）
SELECT * FROM casbin_rule
WHERE ptype = 'p'
  AND v0 = '888'
  AND v1 LIKE '/portForward%';
```

### 检查3：浏览器控制台错误

1. 按 `F12` 打开浏览器开发者工具
2. 切换到 `Console` 标签
3. 点击"新建"按钮
4. 查看错误信息

常见错误：
- `403 Forbidden` → 权限不足
- `404 Not Found` → API未注册
- `500 Internal Server Error` → 后端错误

### 检查4：后端日志

查看后端日志中的权限验证信息：
```
[INFO] 用户访问API /api/portForward/createPortForward
[INFO] 权限验证通过
[INFO] 权限验证失败，缺少权限
```

---

## 💡 快速修复命令

如果你想快速解决，执行以下命令：

```bash
# 1. 停止后端服务（Ctrl+C）

# 2. 连接到数据库
mysql -u root -p your_database_name

# 3. 执行以下SQL（复制粘贴整个块）
```

```sql
-- 快速修复SQL
USE your_database_name;

-- 1. 删除旧的端口转发API和权限（如果存在）
DELETE FROM casbin_rule WHERE v1 LIKE '/portForward%';
DELETE FROM sys_apis WHERE api_group = '端口转发';

-- 2. 重新插入端口转发API
INSERT INTO `sys_apis` (`path`, `description`, `api_group`, `method`, `created_at`, `updated_at`) VALUES
('/portForward/createPortForward', '新建端口转发规则', '端口转发', 'POST', NOW(), NOW()),
('/portForward/deletePortForward', '删除端口转发规则', '端口转发', 'DELETE', NOW(), NOW()),
('/portForward/deletePortForwardByIds', '批量删除端口转发规则', '端口转发', 'DELETE', NOW(), NOW()),
('/portForward/updatePortForward', '更新端口转发规则', '端口转发', 'PUT', NOW(), NOW()),
('/portForward/updatePortForwardStatus', '更新端口转发规则状态', '端口转发', 'PUT', NOW(), NOW()),
('/portForward/findPortForward', '根据ID获取端口转发规则', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getPortForwardList', '获取端口转发规则列表', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getServerIP', '获取服务器IP地址', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getForwarderStatus', '获取端口转发运行状态', '端口转发', 'GET', NOW(), NOW()),
('/portForward/getAllForwarderStatus', '获取所有端口转发运行状态', '端口转发', 'GET', NOW(), NOW());

-- 3. 为所有角色添加端口转发权限
INSERT INTO casbin_rule (ptype, v0, v1, v2)
SELECT 'p', sa.authority_id, CONCAT(sapi.path, sapi.method), sapi.method
FROM sys_authorities sa
CROSS JOIN sys_apis sapi
WHERE sapi.api_group = '端口转发';

-- 4. 验证
SELECT '端口转发API数量:' as info, COUNT(*) as count FROM sys_apis WHERE api_group = '端口转发'
UNION ALL
SELECT '端口转发权限数量:' as info, COUNT(*) as count FROM casbin_rule WHERE v1 LIKE '/portForward%';
```

```bash
# 4. 退出MySQL
exit;

# 5. 重新启动后端服务
cd D:\devops\test-2025\docker-gpu-manage\server
go run main.go

# 6. 清除浏览器缓存并重新登录前端
```

---

## 📝 完整的SQL脚本

我已经创建了完整的SQL脚本文件：
- `端口转发权限配置.sql`

这个脚本包含：
- API创建语句
- 权限分配语句
- 验证查询语句
- 故障排查语句

---

## ✅ 验证修复成功

执行完修复步骤后：

1. **重新登录前端**
2. **进入端口转发页面**
3. **点击"新建"按钮**
4. **应该能正常打开创建对话框**

如果仍然提示权限不足，请提供：
1. 浏览器控制台的错误信息（F12 → Console）
2. 后端日志中的相关错误
3. 当前使用的用户名和角色

这样我可以更准确地定位问题。
