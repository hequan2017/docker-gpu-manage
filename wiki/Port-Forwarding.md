# 端口转发管理

## 概述

端口转发管理功能提供灵活的网络端口转发规则管理，支持 TCP/UDP 协议的端口映射，自动获取本机 IP 地址，实现灵活的网络流量转发。适用于容器服务端口映射、内网服务外网访问、负载均衡配置等场景。

## 功能特性

### 核心功能

- ✅ **多协议支持**：支持 TCP 和 UDP 协议
- ✅ **自动获取 IP**：自动获取服务器所有非 127.0.0.1 的 IP 地址
- ✅ **灵活映射**：源 IP:端口 → 目标 IP:端口
- ✅ **状态切换**：实时启用/禁用转发规则
- ✅ **批量操作**：支持批量删除规则
- ✅ **实时监控**：实时显示转发状态和活跃连接数

## 数据模型

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 源IP地址 | string | ✅ | 监听的IP地址 |
| 源端口 | int | ✅ | 监听的端口号（1-65535） |
| 协议类型 | string | ✅ | TCP 或 UDP |
| 目标IP地址 | string | ✅ | 转发到的目标IP地址 |
| 目标端口 | int | ✅ | 转发到的目标端口（1-65535） |
| 状态 | bool | ✅ | 是否启用转发 |
| 规则描述 | string | | 规则说明信息 |

## 使用指南

### 创建转发规则

1. 进入【端口转发】管理页面
2. 点击"新建规则"按钮
3. 填写规则信息：
   - 点击"获取服务器IP"按钮自动填充可用IP
   - 或手动输入源IP地址
   - 输入源端口（1-65535）
   - 选择协议类型（TCP/UDP）
   - 输入目标IP地址
   - 输入目标端口（1-65535）
   - 配置是否启用（默认启用）
   - 填写规则描述（可选）
4. 点击"确定"创建规则

### 获取服务器IP

系统会自动获取服务器所有非 127.0.0.1 的 IP 地址：

```bash
# 自动获取的IP包括：
# eth0: 192.168.1.100
# eth1: 10.0.0.50
# ens33: 172.16.0.5
```

### 编辑转发规则

1. 在规则列表中找到要编辑的规则
2. 点击"编辑"按钮
3. 修改规则信息
4. 点击"确定"保存更改

### 启用/禁用转发规则

1. 在规则列表中找到要操作的规则
2. 点击状态开关切换
3. 规则状态实时更新

### 删除转发规则

**单个删除：**
1. 在规则列表中找到要删除的规则
2. 点击"删除"按钮
3. 确认删除操作

**批量删除：**
1. 勾选多个规则
2. 点击"批量删除"按钮
3. 确认删除操作

## 应用场景

### 容器服务端口映射

将容器内部端口映射到宿主机外部端口：

```
# 示例：映射容器 Web 服务
源：0.0.0.0:8080 → 容器：172.17.0.2:80
```

### 内网服务外网访问

实现内网服务通过公网 IP 访问：

```
# 示例：内网数据库服务
源：公网IP:3306 → 内网：192.168.1.100:3306
```

### 负载均衡配置

配合负载均衡器实现流量分发：

```
# 示例：多节点负载均衡
源1：0.0.0.0:80 → 节点1：10.0.0.1:80
源2：0.0.0.0:81 → 节点2：10.0.0.2:80
```

### 服务代理转发

搭建服务代理，实现跨网络访问：

```
# 示例：跨网络服务访问
源：网络A:8080 → 网络 B:10.0.0.1:80
```

### 安全访问控制

通过端口转发限制特定服务的访问入口：

```
# 示例：限制管理后台访问
源：VPN IP:8080 → 管理后台：192.168.1.100:8080
```

## 技术实现

### 转发器类型

系统支持两种转发器类型：

#### TCP 转发器

- 监听指定的 TCP 端口
- 接受 TCP 连接
- 转发到目标 TCP 端口
- 支持长连接

#### UDP 转发器

- 监听指定的 UDP 端口
- 接收 UDP 数据包
- 转发到目标 UDP 端口
- 支持数据包级别的转发

### 连接管理

- **活跃连接数**：实时显示当前的活跃连接数
- **自动重连**：连接断开时自动重连
- **连接超时**：可配置连接超时时间

### 自动刷新

- 每 5 秒自动刷新转发规则状态
- 实时更新活跃连接数
- 无需手动刷新页面

## 端口范围

### 有效端口范围

- **最小端口**：1
- **最大端口**：65535
- **常用端口**：
  - Web 服务：80, 443, 8080, 8443
  - 数据库：3306, 5432, 27017
  - 缓存：6379, 11211
  - SSH：22, 2022

### 系统保留端口

建议避免使用系统保留端口（0-1023），除非有特殊需求。

## 配置示例

### Web 服务端口转发

```
源：0.0.0.0:80 → 目标：172.17.0.2:80
协议：TCP
状态：启用
```

### 数据库端口转发

```
源：192.168.1.100:3306 → 目标：192.168.1.200:3306
协议：TCP
状态：启用
```

### UDP 转发示例

```
源：0.0.0.0:53 → 目标：8.8.8.8:53
协议：UDP
状态：启用
```

## 常见问题

### Q1: 端口被占用怎么办？

A:
1. 检查端口是否被其他程序占用
2. 使用 `netstat` 或 `lsof` 查看端口占用：
   ```bash
   netstat -tuln | grep <端口号>
   lsof -i:<端口号>
   ```
3. 更改转发规则的源端口
4. 或停止占用端口的程序

### Q2: 转发规则不生效怎么办？

A:
1. 检查规则状态是否为"启用"
2. 检查源IP和端口是否正确
3. 检查目标IP和端口是否可达
4. 检查防火墙设置
5. 查看转发日志排查问题

### Q3: 如何同时监听多个IP？

A:
- 创建多条转发规则
- 使用相同的端口但不同的源IP
- 或使用 `0.0.0.0` 监听所有IP

### Q4: TCP 和 UDP 有什么区别？

A:
- **TCP**：
  - 面向连接，可靠传输
  - 适用于 Web、数据库等需要可靠传输的场景
  - 支持长连接

- **UDP**：
  - 无连接，不可靠传输
  - 适用于 DNS、游戏等实时性要求高的场景
  - 支持广播和多播

### Q5: 如何查看转发状态？

A:
- 在转发规则列表中查看"状态"列
- 绿色：已启用
- 灰色：已禁用
- 查看活跃连接数了解转发使用情况

## API 接口

### 创建端口转发规则
```
POST /portForward/createPortForward
```

### 更新端口转发规则
```
PUT /portForward/updatePortForward
```

### 更新规则状态
```
PUT /portForward/updatePortForwardStatus
```

### 删除端口转发规则
```
DELETE /portForward/deletePortForward
```

### 批量删除
```
DELETE /portForward/deletePortForwardByIds
```

### 查询规则
```
GET /portForward/findPortForward
```

### 获取规则列表
```
GET /portForward/getPortForwardList
```

### 获取服务器IP
```
GET /portForward/getServerIP
```

### 获取转发状态
```
GET /portForward/getForwarderStatus
```

### 获取所有转发状态
```
GET /portForward/getAllForwarderStatus
```

## 技术实现

- **后端插件**：`server/plugin/portforward/`
- **前端插件**：`web/src/plugin/portforward/`
- **数据表**：`gva_port_forward`
- **初始化SQL**：`portforward_install.sql`

## 相关文档

- [容器实例管理](Container-Instances.md)
- [算力节点管理](Compute-Nodes.md)

---

**最后更新**：2025-01-22
