# SSH 跳板机

## 概述

SSH 跳板机是天启算力管理平台的安全容器访问服务，用户可以通过 SSH 连接跳板机后选择并连接到自己的容器实例。提供安全的认证机制和交互式容器选择体验。

## 功能特性

### 核心功能

- ✅ **SSH 密码认证**：使用系统用户账号密码进行认证
- ✅ **自动容器列表**：自动显示用户创建的容器列表
- ✅ **管理员特权**：管理员可以查看和连接所有容器
- ✅ **交互式选择**：简单的数字选择界面
- ✅ **终端自适应**：终端窗口大小自动适配（支持 vim 等编辑器）
- ✅ **TLS/非TLS 支持**：自动适配 Docker 连接方式

### 安全特性

- ✅ **用户认证**：基于系统用户的密码验证
- ✅ **权限隔离**：普通用户只能看到自己的容器
- ✅ **审计日志**：记录所有 SSH 登录和操作日志
- ✅ **会话管理**：安全的会话超时机制

## 配置说明

### 服务配置

在 `server/config.yaml` 中配置：

```yaml
jumpbox:
  enabled: true              # 是否启用SSH跳板机
  port: 2026                 # SSH监听端口（默认2026）
  server-ip: "192.168.112.148"  # 服务器IP
  host-key: ""                # SSH主机密钥路径（可选，不设置则自动生成）
  banner: "欢迎使用SSH跳板机服务\r\n"  # SSH欢迎信息
```

### 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| enabled | bool | false | 是否启用 SSH 跳板机服务 |
| port | int | 2026 | SSH 服务监听端口 |
| server-ip | string | - | 服务器 IP 地址，用于显示连接提示 |
| host-key | string | "" | SSH 主机密钥文件路径 |
| banner | string | - | SSH 登录欢迎信息 |

## 使用指南

### 连接步骤

#### 1. 启动服务

SSH 跳板机服务会在后端服务启动时自动启动（如果 `enabled=true`）

#### 2. 连接跳板机

```bash
ssh -p 2026 用户名@服务器IP

# 示例
ssh -p 2026 admin@192.168.112.148
```

#### 3. 认证登录

输入系统用户密码进行认证

#### 4. 选择容器

认证成功后，系统会显示可用的容器列表：

```
=== 可用容器列表 ===
[1] my-tensorflow-container-1234567890-node1
[2] dev-pytorch-instance-9876543210-node2
[3] data-science-notebook-1111111111-node3
=====================================

请输入容器序号（1-3），或输入 'q' 退出：
```

#### 5. 连接容器

输入容器序号选择要连接的容器，或输入 'q' 退出

#### 6. 容器操作

连接成功后即可在容器内执行命令：
- 支持 bash/sh 等命令
- 支持 vim 等编辑器
- 终端窗口大小自动适配
- 在 vim 中使用 `Shift+Insert` 或鼠标中键粘贴剪贴板内容

### 快捷键

| 快捷键 | 说明 |
|--------|------|
| `Ctrl+C` | 发送中断信号（SIGINT） |
| `Ctrl+D` | 退出会话 |
| `Shift+Insert` | 粘贴剪贴板内容（vim） |

## 权限控制

### 普通用户权限

- 只能看到和连接自己创建的容器
- 无法访问其他用户的容器
- 基于 user_id 进行权限判断

### 管理员权限

- 可以看到和连接所有容器
- `authorityId = 888` 的用户为管理员
- 可以访问系统内任何容器

### 权限判断逻辑

```go
// 管理员判断
if user.AuthorityId == 888 {
    // 显示所有容器
    containers = getAllContainers()
} else {
    // 只显示用户自己的容器
    containers = getUserContainers(user.Id)
}
```

## 终端特性

### 终端自适应

- 终端窗口大小自动适配
- 支持窗口大小调整
- 自动发送终端大小信号

### 编辑器支持

- 支持 vim、nano 等编辑器
- 正常显示颜色和光标移动
- 支持复制粘贴操作

### 会话管理

- 自动检测连接状态
- 检测到断开时自动清理会话
- 会话超时自动断开

## Docker 连接方式

### TLS 连接

当算力节点启用 TLS 时：
- 使用 TLS 证书连接 Docker
- 自动验证服务器证书
- 使用客户端证书进行认证

### 非 TLS 连接

当算力节点未启用 TLS 时：
- 直接连接 Docker API
- 无需证书验证
- 简单快速的连接方式

## 安全建议

### 密码安全

1. **使用强密码**
   - 包含大小写字母、数字、特殊字符
   - 长度至少 8 位

2. **定期更换密码**
   - 建议每 90 天更换一次
   - 避免使用默认密码

3. **密码复杂度要求**
   - 不能包含用户名
   - 不能使用常见密码
   - 不能使用连续字符

### 访问控制

1. **限制访问源**
   - 使用防火墙限制访问源 IP
   - 仅允许可信网络访问

2. **端口修改**
   - 修改默认 SSH 端口（2026）
   - 使用非常见端口降低攻击风险

3. **日志审计**
   - 定期检查 SSH 登录日志
   - 及时发现异常登录行为

### 密钥管理

```bash
# 生成主机密钥
ssh-keygen -t rsa -b 4096

# 密钥存储位置
~/.ssh/id_rsa          # 私钥
~/.ssh/id_rsa.pub      # 公钥
```

## 故障排查

### 无法连接跳板机

**可能原因：**
1. SSH 服务未启动
2. 端口被防火墙阻止
3. 服务器 IP 不正确
4. 网络连接问题

**排查步骤：**
1. 检查 `jumpbox.enabled` 是否为 `true`
2. 检查配置的端口是否正确
3. 使用 `telnet` 测试端口：
   ```bash
   telnet 服务器IP 2026
   ```
4. 检查防火墙规则

### 认证失败

**可能原因：**
1. 用户名或密码错误
2. 用户不存在
3. 用户被禁用

**排查步骤：**
1. 确认用户名拼写正确
2. 重置用户密码
3. 检查用户状态

### 容器连接失败

**可能原因：**
1. 容器已停止或删除
2. Docker 连接失败
3. 容器内没有 SSH 服务

**排查步骤：**
1. 检查容器状态是否为 `running`
2. 检查算力节点 Docker 连接状态
3. 确认容器镜像包含 SSH 服务

### 终端显示异常

**可能原因：**
1. 终端类型不匹配
2. 环境变量配置问题
3. 容器资源不足

**排查步骤：**
1. 尝试使用不同的终端模拟器
2. 检查容器内的环境变量
3. 增加容器资源配额

## API 接口

SSH 跳板机服务本身不提供 REST API，但可以通过以下方式管理：

### 启用/禁用服务

修改 `server/config.yaml` 中的 `jumpbox.enabled` 配置，然后重启后端服务。

### 配置修改

1. 编辑配置文件
2. 重启后端服务
3. 服务会自动应用新配置

## 日志和监控

### 日志位置

SSH 跳板机日志会输出到后端日志中：
- 登录成功/失败日志
- 容器连接日志
- 错误和异常日志

### 日志级别

- **Info**：正常的登录和操作日志
- **Warn**：警告信息（如连接失败）
- **Error**：错误信息（如认证失败）

## 相关文档

- [容器实例管理](Container-Instances.md)
- [算力节点管理](Compute-Nodes.md)
- [用户权限管理](Authorization.md)

---

**最后更新**：2025-01-22
