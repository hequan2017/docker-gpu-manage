# 容器实例管理

## 概述

容器实例管理是天启算力管理平台的核心功能，提供 GPU 容器实例的完整生命周期管理能力。用户可以轻松创建、启动、停止、重启和删除 GPU 容器实例，同时支持显存切分、自动删除数据卷等高级功能。

## 功能特性

### 核心功能

- ✅ **全生命周期管理**：创建、启动、停止、重启、删除容器实例
- ✅ **智能主机匹配**：根据产品规格自动选择最优算力节点
- ✅ **显存切分支持**：支持 HAMi 显存切分技术
- ✅ **数据卷管理**：删除容器时自动删除挂载的数据卷
- ✅ **实时监控**：CPU、内存、网络I/O、块设备I/O、进程数实时监控
- ✅ **多种访问方式**：SSH 跳板机、Web 终端

### 容器状态

| 状态 | 说明 |
|------|------|
| `creating` | 创建中 |
| `running` | 运行中 |
| `exited` | 已停止 |
| `failed` | 创建失败 |

## 数据模型

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 镜像 | 关联 | ✅ | 关联镜像库 |
| 产品规格 | 关联 | ✅ | 关联产品规格 |
| 用户 | 关联 | | 后端自动填写 |
| 算力节点 | 关联 | ✅ | 关联算力节点 |
| 实例名称 | string | ✅ | 实例名称（仅支持字母、数字、横线、下划线） |
| 容器状态 | string | | 后端自动填写 |
| 备注 | string | | 备注信息 |

## 使用指南

### 创建实例

1. 进入【容器实例】管理页面
2. 点击"新建实例"按钮
3. 填写实例信息：
   - 选择镜像库
   - 选择产品规格
   - 系统自动匹配可用算力节点
   - 输入实例名称（仅支持字母、数字、横线、下划线）
   - 可选：填写备注信息
4. 点击"确定"创建实例

### 智能主机匹配

系统会根据以下条件自动匹配算力节点：
- GPU 型号和数量
- 显存容量
- CPU 核心数
- 内存大小
- 系统盘和数据盘容量

### 实例操作

#### 查看详情
- 查看实例完整信息
- 实时监控资源使用情况
- 查看容器配置参数

#### SSH连接
- 显示 SSH 连接命令
- 支持一键复制命令
- 通过 SSH 跳板机连接到容器

#### 启动/停止
- 启动已停止的容器
- 停止运行中的容器
- 操作即时生效

#### 重启
- 重启容器实例
- 保留容器配置和数据

#### 日志查看
- 查看容器运行日志
- 支持实时刷新
- 可配置日志行数

#### Web终端
- 在浏览器中直接操作容器
- 支持 bash/sh 命令
- 无需额外工具

#### 删除实例
- 删除容器实例
- 自动删除所有挂载的数据卷
- 删除前请确认数据已备份

## 资源监控

### 监控指标

- **CPU使用率**：实时显示 CPU 使用百分比
- **内存使用率**：显示内存使用百分比和详细使用量
- **网络 I/O**：显示网络接收和发送字节数
- **块设备 I/O**：显示块设备读取和写入字节数
- **进程数**：显示当前容器进程数

### 自动刷新

- 容器运行时每 5 秒自动刷新统计信息
- 支持手动刷新按钮

## 权限控制

### 用户权限

- **普通用户**：只能操作自己创建的实例
- **管理员**：可以操作所有实例

### 权限说明

- 查看实例：所有用户都可以查看
- 创建实例：所有登录用户都可以创建
- 操作实例：只能操作自己的实例（管理员除外）
- 删除实例：只能删除自己的实例（管理员除外）

## 定时任务

### 自动同步

系统每 30 秒自动执行以下任务：

1. **检查算力节点 Docker 状态**
   - 更新节点连接状态（connected/failed/unknown）
   - 确保 Docker 连接可用

2. **检查容器运行状态**
   - 同步容器实际状态到数据库
   - 刷新 CPU/内存/GPU 显存使用率
   - 更新容器状态信息

3. **日志优化**
   - 仅记录必要的 Error/Warn 及少量 Debug 日志
   - 降低控制台噪声

## 注意事项

### 实例名称规范

- 仅支持字母、数字、横线（-）和下划线（_）
- 不支持中文和特殊字符
- 建议使用有意义的名称，便于识别

### 数据卷管理

- 删除容器时会自动删除所有挂载的命名数据卷
- 自动识别容器挂载的所有数据卷
- 即使容器删除失败，也会尝试删除数据卷
- 删除前请确保重要数据已备份

### 显存切分

- 支持显存切分的产品规格创建容器时，会自动配置相关参数
- 从算力节点的 HAMi-core 目录字段读取路径
- 挂载到容器 `/libvgpu/build`
- 自动注入环境变量：
  - `LD_PRELOAD`
  - `CUDA_DEVICE_MEMORY_LIMIT`
  - `CUDA_DEVICE_SM_LIMIT`

## 常见问题

### Q1: 为什么创建实例后状态一直是 "creating"？

A: 可能的原因：
- 算力节点 Docker 连接失败
- 镜像拉取失败
- 资源不足（GPU、内存、磁盘）
- 检查算力节点状态和日志

### Q2: 如何查看实例的详细信息？

A: 点击实例列表中的"详情"按钮，可以查看：
- 实例基本信息
- 资源使用情况
- 容器配置参数
- 实时监控数据

### Q3: 删除实例后数据卷会被删除吗？

A: 是的，删除实例时会自动删除所有挂载的命名数据卷。请确保重要数据已提前备份。

### Q4: 如何通过 SSH 连接到容器？

A:
1. 确保已启动 SSH 跳板机服务
2. 在实例列表中点击"SSH连接"
3. 复制显示的 SSH 命令
4. 在终端中执行命令连接

## API 接口

### 创建实例
```
POST /container/createContainer
```

### 删除实例
```
DELETE /container/deleteContainer
```

### 启动实例
```
POST /container/startContainer
```

### 停止实例
```
POST /container/stopContainer
```

### 重启实例
```
POST /container/restartContainer
```

### 查看实例列表
```
GET /container/getContainerList
```

### 获取实例详情
```
GET /container/findContainer
```

## 相关文档

- [算力节点管理](Compute-Nodes.md)
- [镜像库管理](Image-Registry.md)
- [产品规格管理](Product-Specs.md)
- [SSH 跳板机](SSH-Jumpbox.md)

---

**最后更新**：2025-01-22
