# 📦 功能模块

本页面详细介绍天启算力管理平台的各个功能模块。

## 1. 镜像库管理

管理 Docker 镜像仓库信息，支持多镜像源配置。

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|:----:|------|
| 名字 | string | ✅ | 镜像库名称 |
| 地址 | string | ✅ | 镜像库地址 |
| 描述 | string | | 镜像库描述 |
| 来源 | string | | 镜像库来源 |
| 是否支持显存切分 | bool | ✅ | 默认否，是否支持 GPU 显存切分 |
| 是否上架 | bool | ✅ | 默认上架 |
| 备注 | string | | 备注信息 |

### 功能特性

- ✅ 支持多镜像源配置
- ✅ 镜像显存切分标记，自动过滤可用规格
- ✅ 上架/下架控制

---

## 2. 算力节点管理

管理 GPU 算力节点，支持 Docker TLS 安全连接，自动测试 Docker 连接状态。

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|:----:|------|
| 名字 | string | ✅ | 节点名称 |
| 区域 | string | | 节点区域 |
| CPU | string | | CPU 信息 |
| 内存 | string | | 内存信息 |
| 系统盘容量 | string | | 系统盘大小 |
| 数据盘容量 | string | | 数据盘大小 |
| IP 地址公网 | string | ✅ | 公网 IP |
| IP 地址内网 | string | ✅ | 内网 IP |
| SSH 端口 | int | ✅ | 默认 22 |
| 用户名 | string | | SSH 用户名 |
| 密码 | string | | SSH 密码 |
| 显卡名称 | string | | GPU 型号 |
| 显卡数量 | int | | GPU 数量 |
| 显存容量 | int | | 单卡显存容量(GB) |
| HAMi-core 目录 | string | | HAMi-core build 目录路径 |
| Docker 连接地址 | string | | Docker API 地址 |
| 使用 TLS | bool | | 默认启用 |
| CA 证书 | text | | TLS CA 证书 |
| 客户端证书 | text | | TLS 客户端证书 |
| 客户端私钥 | text | | TLS 客户端私钥 |
| Docker 状态 | string | | 自动测试（connected/failed/unknown） |
| 是否上架 | bool | ✅ | 默认上架 |
| 备注 | string | | 备注信息 |

### 功能特性

- ✅ 创建或更新节点时自动测试 Docker TCP 连接
- ✅ 实时显示 Docker 连接状态（已连接/连接失败/未知）
- ✅ 支持 TLS 和非 TLS 连接
- ✅ HAMi 显存切分目录配置

---

## 3. 产品规格管理

定义 GPU 算力产品规格和定价，支持无显卡规格（CPU 容器）和显存切分。

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|:----:|------|
| 名称 | string | ✅ | 规格名称 |
| 显卡型号 | string | | GPU 型号（GPU=0 时可为空） |
| 显卡数量 | int | | GPU 数量（0 表示无显卡） |
| 显存容量(GB) | int | | 显存容量 |
| 是否支持显存切分 | bool | ✅ | 默认否 |
| CPU 核心数 | int | | CPU 核心数 |
| 内存(GB) | int | | 内存大小 |
| 系统盘容量(GB) | int | | 系统盘大小 |
| 数据盘容量(GB) | int | | 数据盘大小 |
| 价格/小时 | float64 | | 每小时价格 |
| 是否上架 | bool | ✅ | 默认上架 |
| 备注 | string | | 备注信息 |

### 功能特性

- ✅ 支持无显卡规格（GPU=0），创建容器时不挂载 GPU 参数
- ✅ 无显卡规格匹配节点时，不检查 GPU 型号和数量
- ✅ 支持显存切分功能，灵活分配 GPU 显存资源
- ✅ 根据镜像和产品规格的显存切分支持情况，智能过滤可用规格

---

## 4. 实例管理

管理 GPU 容器实例的完整生命周期，提供丰富的容器操作功能。

### 数据字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|:----:|------|
| 镜像 | 关联 | ✅ | 关联镜像库 |
| 产品规格 | 关联 | ✅ | 关联产品规格 |
| 用户 | 关联 | | 后端自动填写 |
| 算力节点 | 关联 | ✅ | 关联算力节点 |
| Docker 容器 ID | string | | 后端自动回填 |
| Docker 容器名称 | string | | 后端自动回填（格式：名称-实例ID-时间戳） |
| 实例名称 | string | ✅ | 实例名称 |
| 容器状态 | string | | 后端自动填写（running/exited/creating/failed） |
| 备注 | string | | 备注信息 |

### 支持操作

| 操作 | 说明 |
|------|------|
| 查看 | 查看实例详细信息，包括资源使用率监控 |
| SSH 连接 | 显示 SSH 连接命令，支持一键复制 |
| 启动 | 启动已停止的容器 |
| 停止 | 停止运行中的容器 |
| 重启 | 重启容器实例 |
| 日志 | 查看容器运行日志（支持实时刷新） |
| 终端 | Web 终端，在浏览器中直接操作容器 |
| 删除 | 删除实例和对应的容器，自动删除挂载的数据卷 |

### 新增实例功能

- ✅ **智能主机匹配**：根据产品规格的 GPU 需求、显存需求、CPU、内存、磁盘等资源进行智能匹配
- ✅ **显存切分支持**：根据镜像的显存切分支持情况，自动过滤可用的产品规格
- ✅ **单卡显存显示**：在选择主机时显示单卡可用显存大小，便于判断是否满足需求
- ✅ **实例名称校验**：实例名称仅支持字母、数字、横线和下划线，不支持中文
- ✅ **资源分配优化**：支持按卡分配显存，更精确地管理 GPU 资源

### 资源监控

| 指标 | 说明 |
|------|------|
| CPU 使用率 | 实时显示 CPU 使用百分比（进度条） |
| 内存使用率 | 实时显示内存使用百分比和详细使用量（进度条） |
| 网络 I/O | 显示网络接收和发送字节数 |
| 块设备 I/O | 显示块设备读取和写入字节数 |
| 进程数 | 显示当前容器进程数 |

- ✅ 自动刷新：容器运行时每 5 秒自动刷新统计信息
- ✅ 手动刷新：支持手动刷新按钮

### 容器状态

| 状态 | 说明 |
|------|------|
| `creating` | 创建中 |
| `running` | 运行中 |
| `exited` | 已停止 |
| `failed` | 创建失败 |

### 权限控制

| 角色 | 权限 |
|------|------|
| 普通用户 | 只能操作自己创建的实例 |
| 管理员 | 可以操作所有实例 |

### 定时任务

- ✅ 每 30 秒自动检查所有算力节点的 Docker 连接状态
- ✅ 自动同步容器的运行状态
- ✅ 刷新 CPU/内存/GPU 显存使用率

### 数据卷管理

- ✅ 删除容器时自动删除所有挂载的命名数据卷
- ✅ 自动识别容器挂载的所有数据卷
- ✅ 即使容器删除失败，也会尝试删除数据卷

---

## 5. SSH 跳板机服务

提供 SSH 跳板机功能，用户可以通过 SSH 连接跳板机后选择并连接到自己的容器实例。

### 功能特性

- ✅ SSH 密码认证（使用系统用户账号密码）
- ✅ 自动显示用户创建的容器列表
- ✅ 支持管理员查看所有容器
- ✅ 交互式容器选择
- ✅ 自动连接到选定的容器
- ✅ 终端窗口大小自动适配（支持 vim 等编辑器）
- ✅ 支持 TLS 和非 TLS 的 Docker 连接

### 使用方法

#### 1. 连接跳板机

```bash
ssh -p 2026 用户名@服务器IP
# 例如：ssh -p 2026 admin@192.168.112.148
```

#### 2. 认证登录

输入系统用户密码进行认证，认证成功后显示容器列表。

#### 3. 选择容器

查看显示的容器列表（格式：序号 实例名称-容器ID-算力节点），输入序号选择要连接的容器，输入 `q` 退出。

#### 4. 容器操作

连接成功后即可在容器内执行命令，支持 vim 等编辑器，窗口大小自动适配。

### 权限说明

| 角色 | 权限 |
|------|------|
| 普通用户 | 只能看到和连接自己创建的容器 |
| 管理员 | 可以看到和连接所有容器 |

---

## 6. Web 终端

内置 Web 终端功能，无需额外工具即可在浏览器中直接操作容器。

### 功能特性

- ✅ 基于 xterm.js 实现
- ✅ 支持 bash/sh
- ✅ 支持 WebSocket 实时通信
- ✅ 支持终端大小自适应

